<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>소켓 테스트 v0.0.1</title>
  <style>
    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
  </style>
</head>
<body>
<h1>소켓 테스트 v0.0.1</h1>
<form id="form">
  <label>
    보내는 사람
    <input id="sender-input" type="text"/>
  </label>
  <label>
    받는 사람
    <input id="receiver-input" type="text"/>
  </label>
  <label>
    메세지
    <input id="message-input" type="text"/>
  </label>
  <button type="submit">전송</button>
</form>
<div id="messages"></div>

<!-- jQuery, SockJS, STOMP.js 라이브러리 로드를 body 끝으로 이동 -->
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js"
    integrity="sha512-+k1pnlgt4F1H8L7t3z95o3/KO+o78INEcXTbnoJQ/F2VqDVhWoaiVml/OEHv9HsVgxUaVW+IbiZPUJQfF/YxZw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<!-- STOMP.js 로드 확인 -->
<script>
  console.log("STOMP object:", Stomp); // 로드 확인
</script>

<script>

  $(document).ready(function() {
    const BROKER_URL = '/ws';  // SockJS를 사용할 때는 단순 경로만 사용
    const SUBSCRIPTION = '/sub/message';
    const DESTINATION = '/pub/hello';

    console.log('BROKER_URL', BROKER_URL);
    console.log('SUBSCRIPTION', SUBSCRIPTION);
    console.log('DESTINATION', DESTINATION);

    let stompClient = null;
    let connection = false; // 연결중인지 여부
    let messages = []; // 응답들
    let token =
      'eyJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6IjM3MDQ2MTY4NTkiLCJyb2xlIjoiVVNFUiIsImlhdCI6MTcyNjgzMDczOSwiZXhwIjoxNzI2ODY2NzM5fQ.LKmY7EHHo9UvGfbZjHQDhxKSVASK9teo_fS3LErt8b0'; // 로그인 토큰

    const $form = $('#form');
    const $senderInput = $('#sender-input');
    const $receiverInput = $('#receiver-input');
    const $messageInput = $('#message-input');

    const stompConfig = {
      connectHeaders: {
        user: 'user' + Math.round(Math.random() * 100),
        login: 'guest',
        passcode: 'guest',
      },
      onConnect(e) {
        console.log('Broker connected.', e);
        // 구독
        subscription = stompClient.subscribe(
          SUBSCRIPTION,
          function (message) {
            console.log('message', message);
            messages.push(message.body);
            document.getElementById('messages').innerHTML =
              messages.join('<br>');
          },
        );

        connection = true;
      },
      onDisconnect() {
        console.log('Broker disconnected.');
        stompClient?.deactivate();
        stompClient = null;
        connection = false;
      },
      onStompError(error) {
        console.error('Broker reported error: ' + error);
      },
      debug(str) {
        console.log('Debugging', str);
      },
      reconnectDelay: 5000,
      heartbeatIncoming: 4000,
      heartbeatOutgoing: 4000,
    };

    function sendMessage(e) {
      e.preventDefault();
      // 메시지 전송
      const body = JSON.stringify({
        content: $messageInput.val(),
        sender: $senderInput.val(),
        receiver: $receiverInput.val(),
      });

      console.log('body', body);

      if (stompClient && stompClient.connected) {
        stompClient.publish({
          destination: DESTINATION,
          body,
        });
      } else {
        alert('소켓 연결이 되어있지 않습니다.');
      }
    }

    function init() {
  $form.on('submit', sendMessage);

  const socket = new SockJS(BROKER_URL); // SockJS 경로를 통해 WebSocket 연결
  stompClient = Stomp.over(socket); // SockJS를 사용하는 Stomp 클라이언트

  // STOMP.js 2.x.x 버전에서는 configure, activate 대신 connect 사용
  stompClient.connect({}, function(frame) {
    console.log('Connected: ' + frame);
    stompClient.subscribe(SUBSCRIPTION, function(message) {
      console.log('Received message:', message.body);
      messages.push(message.body);
      document.getElementById('messages').innerHTML = messages.join('<br>');
    });
  }, function(error) {
    console.log('STOMP error:', error);
  });
}


    init();
  });
</script>
</body>
</html>
