<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>소켓 테스트 v0.0.1</title>
  <style>
    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
  </style>
</head>
<body>
<h1>소켓 테스트 v0.0.1</h1>
<form id="form">
  <label>
    보내는 사람
    <input id="sender-input" type="text"/>
  </label>
  <label>
    받는 사람
    <input id="receiver-input" type="text"/>
  </label>
  <label>
    메세지
    <input id="message-input" type="text"/>
  </label>
  <button type="submit">전송</button>
</form>
<div id="messages"></div>

<!-- jQuery, SockJS, STOMP.js 라이브러리 로드를 body 끝으로 이동 -->
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js"
    integrity="sha512-+k1pnlgt4F1H8L7t3z95o3/KO+o78INEcXTbnoJQ/F2VqDVhWoaiVml/OEHv9HsVgxUaVW+IbiZPUJQfF/YxZw=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
  $(document).ready(function() {
    const BROKER_URL = '/ws';  // SockJS 경로
    const SUBSCRIPTION = '/sub/message';
    const DESTINATION = '/pub/hello';

    let stompClient = null;
    let messages = []; // 메시지 저장 배열
    let token =
      'eyJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6IjM3MDQ2MTY4NTkiLCJyb2xlIjoiVVNFUiIsImlhdCI6MTcyNjgzMDczOSwiZXhwIjoxNzI2ODY2NzM5fQ.LKmY7EHHo9UvGfbZjHQDhxKSVASK9teo_fS3LErt8b0'; // 로그인 토큰

    const $form = $('#form');
    const $senderInput = $('#sender-input');
    const $receiverInput = $('#receiver-input');
    const $messageInput = $('#message-input');

    // 메시지 전송 함수
    function sendMessage(e) {


      e.preventDefault();

      // 현재 시간을 yyyy-MM-dd HH:mm:ss 형식으로 생성
      const currentDateTime = new Date().toISOString().slice(0, 19).replace('T', ' ');

      const body = JSON.stringify({
        content: $messageInput.val(),
        senderId: $senderInput.val(),
        receiverId: $receiverInput.val(),
        createdAt : currentDateTime
      });

      console.log('전송할 메시지:', body);

      if (stompClient && stompClient.connected) {
        stompClient.send(DESTINATION, {}, body); // 구형 방식에서 send() 메서드를 사용하여 메시지 전송
      } else {
        alert('소켓 연결이 되어 있지 않습니다.');
      }
    }

    // 소켓 연결 초기화 함수
    function init() {
      $form.on('submit', sendMessage);

      const socket = new SockJS(BROKER_URL); // SockJS 경로로 WebSocket 연결
      stompClient = Stomp.over(socket); // STOMP 클라이언트 생성

      // STOMP 클라이언트 연결
      stompClient.connect({}, function(frame) {
        console.log('연결 성공: ' + frame);

        // 메시지 구독 설정
        stompClient.subscribe(SUBSCRIPTION, function(message) {
          console.log('받은 메시지:', message.body);
          messages.push(message.body); // 메시지를 배열에 저장
          document.getElementById('messages').innerHTML = messages.join('<br>'); // 메시지 화면 출력
        });
      }, function(error) {
        console.log('STOMP 연결 오류:', error);
      });
    }

    // 초기화 함수 실행
    init();
  });
</script>
</body>
</html>
